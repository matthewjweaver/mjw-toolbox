# ssh_bad_boys:
#   < authlog awk '/Failed.*user/ { print $13 } /Failed.*root/ { $11 }'|sort -u|sed -e's%$%/32,%g'|xargs
# check & load:
#   doas pfctl -nf ./pf.conf && doas rsync pf.conf /etc/pf.conf && doas pfctl -f /etc/pf.conf

private_nets="{ 10.0.0.0/8, 100.64.0.0/10, 172.16.0.0/12, 192.0.0.0/24, 192.168.0.0/16, 198.18.0.0/15 }"

net_int="192.168.223.0/24"
net_haven="192.168.235.0/24"

ext_if="em0"
int_if="vether0"
haven_if="em1"

br_int="{ bridge0 }"
br_int_ifs="{ em2, em3, em4, em5, em6, em7 }"

ext_protos="{ ah, esp }"
ext_services="{ domain, http, https, ipsec-nat-t, isakmp, ssh }"
otheym_ext_services="{ 32400 }"
int_services="{ domain, ipsec-nat-t, isakmp, ntp, ssh, http, https, tftp }"

sietchtabr_ext="108.56.184.72"
sietchtabr_ext_nat="108.56.184.72"
ps4_ext="108.56.184.72"
otheym_ext="108.56.184.72"

sietchumbu_int="192.168.235.2"
otheym_int="192.168.223.2"
ps4_int="192.168.223.5"

lightbulbs="{ 192.168.223.20, 192.168.223.21, 192.168.223.22, 192.168.223.23 }"


set loginterface $ext_if
# XXX TODO(matthewjweaver): filter enc0, too
set skip on { lo, enc0 }
block return log	# default to block and log

# internal bridge & member interfaces
pass quick on $br_int
pass quick on $br_int_ifs

# proxy all ftp
pass in quick inet proto tcp to port ftp divert-to 127.0.0.1 port 8021

# anchors
anchor "ftp-proxy/*"

# sietchtabr's external interface
block drop quick on $ext_if inet6
block drop in quick on $ext_if inet from $private_nets to any
block drop log on $ext_if

pass in quick on $ext_if proto $ext_protos from any to $sietchtabr_ext
pass in quick on $ext_if proto { tcp, udp } from any to $sietchtabr_ext port $ext_services keep state
pass in quick on $ext_if proto tcp from any to $otheym_ext port $otheym_ext_services rdr-to $otheym_int modulate state

pass out quick on $ext_if proto $ext_protos from $sietchtabr_ext to any
pass out quick on $ext_if proto { tcp, udp } from $sietchtabr_ext to any port $ext_services keep state
pass out quick on $ext_if proto udp from $sietchtabr_ext to any port { domain, ntp } keep state
pass out quick on $ext_if proto tcp from $sietchtabr_ext to any port { domain, ftp, http, https, ntp, ssh } modulate state
pass out quick on $ext_if proto tcp from $sietchtabr_ext to any modulate state
pass out quick on $ext_if inet proto icmp from $sietchtabr_ext to any icmp-type 8 code 0 keep state

pass out quick on $ext_if from $ps4_int to any nat-to $ps4_ext
pass out quick on $ext_if from $otheym_int to any nat-to $otheym_ext
pass out quick on $ext_if from $net_int to any nat-to $sietchtabr_ext_nat
pass out quick on $ext_if from $net_haven to any nat-to $sietchtabr_ext

# sietchtabr internal interface/downlink
block drop log quick on $int_if inet proto udp from any to $int_if:broadcast port { 32412, 32414 }
block log on $int_if from any to $net_haven
block return log on $int_if

pass in quick on $int_if inet proto udp from $lightbulbs to any port { domain, ntp } keep state
block return log quick on $int_if from $lightbulbs to any
block return log quick on $int_if from any to $lightbulbs

pass quick on $int_if proto { ah, esp }

pass in quick on $int_if inet proto tcp from $net_int to any port ftp divert-to 127.0.0.1 port 8021
pass in quick on $int_if inet proto icmp from any to ($int_if) icmp-type 8 code 0 keep state
pass in quick on $int_if proto udp from { $net_int, $net_haven } to ($int_if) port $int_services keep state
pass in quick on $int_if proto tcp from { $net_int, $net_haven } to ($int_if) port $int_services modulate state
pass in quick on $int_if inet proto udp from { 0.0.0.0, $net_int } port 68 to { ($int_if), 255.255.255.255 } port 67 keep state
pass in quick on $int_if from $net_int to ! $net_int keep state

pass out on $int_if keep state

# sietchtabr mgt interface
block return log on $haven_if
pass in log quick on $haven_if inet proto udp from { 0.0.0.0, $net_haven } port 68 to { ($haven_if), 255.255.255.255 } port 67 keep state
pass in log quick on $haven_if inet from $sietchumbu_int to ($haven_if) keep state
pass in log quick on $haven_if inet proto tcp from $sietchumbu_int to any port { https, ssh } keep state
pass out log quick on $haven_if inet from ($haven_if) to $sietchumbu_int keep state
